---
- name: debug
  ansible.builtin.debug:
    msg:
      - "debug"
      # - "instance {{ instance }}"
      # - "item {{ item }}"
      # - "item.name {{ item.name }}"
      - "item.0.name {{ item.0.name }}"
      # - "item.overlay_name {{ item.1.overlay_name }}"
      - "item.1.overlay_name {{ item.1.overlay_name }}"
      # - "item.overlay_name {{ item.1.bbb_greenlight_custom_locale.overlay_name }}"

- name: Load file content
  ansible.builtin.uri:
    url: "{{ item.1.source }}"
    return_content: true
  register: bbb_greenlight_overlay_file
  when: item.1.bbb_greenlight_overlay_type  == "json"

- name: apply patch welcome json
  set_fact:
    bbb_greenlight_overlay_file: "{{ bbb_greenlight_overlay_file | combine(item.1.greenlight_custom_patch | from_json, recursive=true | to_nice_json) }}"
  when: item.1.bbb_greenlight_overlay_type  == "json"

- name: Create docker volume
  ansible.builtin.file:
    path: "/docker_volumes/content_overlay_{{ item.0.name }}_{{ item.1.overlay_name }}"
    state: directory
    mode: '644'

- name: Save patched json in docker_volume
  ansible.builtin.copy:
    content: "{{ bbb_greenlight_overlay_file }}"
    dest: "/docker_volumes/content_overlay_{{ item.0.name }}_{{ item.1.overlay_name }}/{{ item.1.overlay_name }}"
  notify: Restart scalelite-nginx
  when: item.1.bbb_greenlight_overlay_type  == "json"

- name: Load and save css in docker_volume
  copy:
    src: "scalelite/{{ item.1.source }}"
    dest: "/docker_volumes/content_overlay_{{ item.0.name }}_{{ item.1.overlay_name }}/{{ item.1.overlay_name }}"
  notify: Restart scalelite-nginx
  when: item.1.bbb_greenlight_overlay_type  == "css"
